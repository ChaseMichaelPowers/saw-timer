<script src="/socket.io/socket.io.js"></script>
<script>
  const t = document.getElementById('t');
  const gate = document.getElementById('gate');
  const enableBtn = document.getElementById('enableBtn');

  const laugh = document.getElementById('laugh');
  const playgame = document.getElementById('playgame');
  const clockstart = document.getElementById('clockstart');

  const socket = io();

  // ------- timer sync -------
  let running=false, endAtMs=null, offset=0, startSeconds=0, freezeSeconds=null, pranking=false;
  function fmt(s){ const m=Math.floor(s/60), r=s%60; return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`; }
  function render(){
    let left=startSeconds;

    if (typeof freezeSeconds === 'number' && pranking) {
      // frozen display during prank minute
      left = freezeSeconds;
    } else if (running && endAtMs){
      const now = Date.now() + offset;
      left = Math.max(0, Math.ceil((endAtMs - now)/1000));
    }

    t.textContent = fmt(left);
    requestAnimationFrame(render);
  }
  socket.on('state', (s)=>{
    const clientNow = Date.now();
    offset = s.serverTimeMs - clientNow;
    running = s.running;
    startSeconds = s.startSeconds;
    endAtMs = s.endAtMs;
    pranking = !!s.pranking;
    freezeSeconds = (typeof s.freezeSeconds === 'number') ? s.freezeSeconds : null;
  });

  // ------- audio arm/queue -------
  let audioArmed = false;
  let pendingPrank = false;
  let pendingStart = false;

  function playLaugh3s(){
    try {
      laugh.pause(); laugh.currentTime = 0; laugh.play();
      setTimeout(()=>{ try { laugh.pause(); laugh.currentTime = 0; } catch(e){} }, 3000);
    } catch(e){}
  }

  enableBtn.addEventListener('click', async ()=>{
    try { await document.documentElement.requestFullscreen(); } catch(e){}
    try {
      await Promise.all([
        clockstart.play().then(()=>{ clockstart.pause(); clockstart.currentTime=0; }),
        laugh.play().then(()=>{ laugh.pause(); laugh.currentTime=0; })
      ]);
    } catch(e){}

    try { await playgame.play(); } catch(e){}

    audioArmed = true;
    gate.style.display = 'none';

    if (pendingStart)  { pendingStart=false; try { clockstart.pause(); clockstart.currentTime=0; clockstart.play(); } catch(e){} }
    if (pendingPrank)  { pendingPrank=false; playLaugh3s(); }
  });

  socket.on('start-sfx', ()=>{
    if (audioArmed) {
      try { clockstart.pause(); clockstart.currentTime=0; clockstart.play(); } catch(e){}
    } else {
      pendingStart = true;
    }
  });

  socket.on('prank', ()=>{
    document.body.classList.remove('prank'); void document.body.offsetWidth; document.body.classList.add('prank');
    if (audioArmed) { playLaugh3s(); } else { pendingPrank = true; }
  });

  render();
</script>
