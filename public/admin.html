<body>
  <h1>‚è± Saw Timer Admin</h1>

  <div id="live" style="margin:14px 0;">
    <div style="opacity:.8;font-size:12px;margin-bottom:4px">Live Timer</div>
    <div id="t" style="font:700 42px/1 monospace;color:#d90429;text-shadow:0 0 10px #4a000a;">00:00</div>
    <div id="flags" style="font:12px/1.4 system-ui;color:#aaa;margin-top:4px"></div>
  </div>

  <div>
    <label>Minutes: <input id="minutes" type="number" min="0" value="8"></label>
  </div>
  <div>
    <button id="start">Start</button>
    <button id="stop">Stop</button>
    <button id="reset">Reset</button>
    <button id="prank">üòà Prank (no time change)</button>
    <button id="jumpBack">‚Ü© 4:00</button>
  </div>
  <div id="status"></div>
  <div id="error"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const keyParam = new URLSearchParams(location.search).get('key');
    const key = keyParam || prompt("Admin Key:");

    const minutesEl = document.getElementById('minutes');
    const statusEl  = document.getElementById('status');
    const errorEl   = document.getElementById('error');
    const tEl       = document.getElementById('t');
    const flagsEl   = document.getElementById('flags');

    function send(type, extra={}) { socket.emit('admin', { key, type, ...extra }); }
    function ok(msg){ statusEl.textContent = msg; errorEl.textContent=''; }
    function err(msg){ errorEl.textContent = msg; statusEl.textContent=''; }

    socket.on('admin-ack', p => (p.ok ? ok(p.msg) : err(p.msg)));
    socket.on('connect', ()=> ok('Connected'));
    socket.on('disconnect', ()=> err('Disconnected'));

    document.getElementById('start').onclick = ()=>{
      const m = parseInt(minutesEl.value || '0', 10);
      if (!m) return err('Enter minutes > 0 before Start');
      send('start', { seconds: m*60 });
      ok(`Start ${m}:00`);
    };
    document.getElementById('stop').onclick    = ()=> { send('stop'); ok('Stopped'); };
    document.getElementById('reset').onclick   = ()=> { send('reset'); ok('Reset'); };
    document.getElementById('prank').onclick   = ()=> { send('prank'); ok('Prank fired'); };
    document.getElementById('jumpBack').onclick= ()=> { send('jumpBack'); ok('Jumped to 4:00'); };

    // --- Live timer mirror (same logic as viewer, no audio) ---
    let running=false, endAtMs=null, offset=0, startSeconds=0, freezeSeconds=null, pranking=false;
    function fmt(s){ const m=Math.floor(s/60), r=s%60; return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`; }
    function render(){
      let left=startSeconds;
      if (typeof freezeSeconds === 'number' && pranking) {
        left = freezeSeconds;
      } else if (running && endAtMs){
        const now = Date.now() + offset;
        left = Math.max(0, Math.ceil((endAtMs - now)/1000));
      }
      tEl.textContent = fmt(left);
      requestAnimationFrame(render);
    }
    socket.on('state', (s)=>{
      const clientNow = Date.now();
      offset = s.serverTimeMs - clientNow;
      running = s.running;
      startSeconds = s.startSeconds;
      endAtMs = s.endAtMs;
      pranking = !!s.pranking;
      freezeSeconds = (typeof s.freezeSeconds === 'number') ? s.freezeSeconds : null;

      flagsEl.textContent = [
        running ? 'running' : 'stopped',
        pranking ? '‚Ä¢ PRANK MINUTE (frozen at 03:00)' : ''
      ].filter(Boolean).join('  ');
    });

    render();
  </script>
</body>
